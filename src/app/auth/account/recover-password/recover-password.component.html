<app-default-layout containerClass="account-pages mt-5 mb-5">
  <div class="row justify-content-center">
    <div class="col-md-8 col-lg-6 col-xl-5">
      <div class="card bg-pattern">
        <div class="card-body p-4">
          <!-- Header -->
          <div class="text-center w-75 m-auto mb-4">
            <div class="auth-logo">
              <a [routerLink]="['/auth/login']" class="logo logo-dark text-center">
                <span class="logo-lg">
                  <img src="assets/images/logos/logo-oots.png" alt="OOTS Colombia" width="150" />
                </span>
              </a>
            </div>

            @if (isResetMode) {
            <h4 class="text-dark-50 text-center mt-3 mb-2">{{ 'auth.resetPasswordTitle' | transloco }}</h4>
            <p class="text-muted mb-0">{{ 'auth.resetPasswordSubtitle' | transloco }}</p>
            } @else {
            <h4 class="text-dark-50 text-center mt-3 mb-2">{{ 'auth.forgotPassword' | transloco }}</h4>
            <p class="text-muted mb-0">
              {{ 'auth.recoverPasswordSubtitle' | transloco }}
            </p>
            }
          </div>

          <!-- Token Inválido (solo en modo reset) -->
          @if (isResetMode && !tokenValid) {
          <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="mdi mdi-alert-circle-outline me-2"></i>
            {{ errorMessage }}
          </div>
          <div class="text-center mt-3">
            <button class="btn btn-primary" type="button" (click)="backToLogin()">
              <i class="mdi mdi-arrow-left me-1"></i>
              {{ 'auth.backToLogin' | transloco }}
            </button>
          </div>
          }

          <!-- Mensaje de Éxito -->
          @else if (successMessage) {
          <ngb-alert type="success" [dismissible]="false" class="mt-3">
            <i class="mdi mdi-check-circle-outline me-2"></i>
            {{ successMessage }}
          </ngb-alert>

          @if (isResetMode) {
          <div class="text-center mt-3">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">{{ 'auth.successRedirect' | transloco }}</span>
            </div>
            <p class="text-muted mt-2">{{ 'auth.successRedirect' | transloco }}</p>
          </div>
          } @else {
          <div class="text-center mt-3">
            <button class="btn btn-primary" type="button" (click)="backToLogin()">
              <i class="mdi mdi-arrow-left me-1"></i>
              {{ 'auth.backToLogin' | transloco }}
            </button>
          </div>
          }
          }

          <!-- Mensaje de Error -->
          @else if (errorMessage) {
          <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="mdi mdi-alert-circle-outline me-2"></i>
            {{ errorMessage }}
            <button type="button" class="btn-close" (click)="errorMessage = ''"></button>
          </div>
          }

          <!-- Formulario -->
          @if (!successMessage && tokenValid) {
          <form name="reset-password-form" [formGroup]="resetPasswordForm" (ngSubmit)="onSubmit()">

            <!-- Formulario FORGOT PASSWORD (sin token) -->
            @if (!isResetMode) {
            <div class="mb-3">
              <label for="email" class="form-label">{{ 'auth.emailLabel' | transloco }} <span
                  class="text-danger">*</span></label>
              <input type="email" class="form-control" id="email" formControlName="email"
                [placeholder]="'auth.emailPlaceholder' | transloco"
                [ngClass]="{ 'is-invalid': formSubmitted && formValues['email'].invalid }" />
              @if (formSubmitted && formValues['email'].invalid) {
              <div class="invalid-feedback">
                @if (formValues['email'].errors?.['required']) {
                <span>{{ 'auth.emailRequired' | transloco }}</span>
                }
                @if (formValues['email'].errors?.['email']) {
                <span>{{ 'auth.emailInvalid' | transloco }}</span>
                }
              </div>
              }
            </div>

            <div class="mb-3 text-center d-grid gap-2">
              <button class="btn btn-primary" type="submit" [disabled]="loading">
                @if (loading) {
                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                {{ 'auth.sending' | transloco }}
                } @else {
                <i class="mdi mdi-email-outline me-1"></i>
                {{ 'auth.sendResetEmail' | transloco }}
                }
              </button>
            </div>

            <div class="text-center">
              <p class="text-muted">
                <small>
                  <i class="mdi mdi-information-outline me-1"></i>
                  {{ 'auth.checkYourEmail' | transloco }}
                </small>
              </p>
            </div>
            }

            <!-- Formulario RESET PASSWORD (con token) -->
            @else {
            <!-- Nueva Contraseña -->
            <div class="mb-3">
              <label for="password" class="form-label">{{ 'auth.newPasswordLabel' | transloco }} <span
                  class="text-danger">*</span></label>
              <div class="input-group">
                <input [type]="showPassword ? 'text' : 'password'" class="form-control" id="password"
                  formControlName="password" [placeholder]="'auth.newPasswordPlaceholder' | transloco"
                  [ngClass]="{ 'is-invalid': formSubmitted && formValues['password'].invalid }" />
                <button class="btn btn-outline-secondary" type="button" (click)="togglePasswordVisibility('password')"
                  [disabled]="loading">
                  <i [class]="showPassword ? 'mdi mdi-eye-off' : 'mdi mdi-eye'"></i>
                </button>
              </div>
              @if (formSubmitted && formValues['password'].invalid) {
              <div class="invalid-feedback d-block">
                @if (formValues['password'].errors?.['required']) {
                <span>{{ 'auth.newPasswordRequired' | transloco }}</span>
                }
                @if (formValues['password'].errors?.['minlength']) {
                <span>{{ 'auth.passwordMinLength' | transloco: { length: 8 } }}</span>
                }
                @if (formValues['password'].errors?.['pattern']) {
                <span>{{ 'auth.passwordPattern' | transloco }}</span>
                }
              </div>
              }
              <small class="form-text text-muted">
                <i class="mdi mdi-information-outline me-1"></i>
                {{ 'auth.passwordStrengthHintFull' | transloco }}
              </small>
            </div>

            <!-- Confirmar Contraseña -->
            <div class="mb-3">
              <label for="confirmPassword" class="form-label">
                {{ 'auth.confirmPasswordLabel' | transloco }} <span class="text-danger">*</span>
              </label>
              <div class="input-group">
                <input [type]="showConfirmPassword ? 'text' : 'password'" class="form-control" id="confirmPassword"
                  formControlName="confirmPassword" [placeholder]="'auth.confirmPasswordPlaceholder' | transloco"
                  [ngClass]="{ 'is-invalid': formSubmitted && (formValues['confirmPassword'].invalid || resetPasswordForm.errors?.['passwordMismatch']) }" />
                <button class="btn btn-outline-secondary" type="button"
                  (click)="togglePasswordVisibility('confirmPassword')" [disabled]="loading">
                  <i [class]="showConfirmPassword ? 'mdi mdi-eye-off' : 'mdi mdi-eye'"></i>
                </button>
              </div>
              @if (formSubmitted && (formValues['confirmPassword'].invalid ||
              resetPasswordForm.errors?.['passwordMismatch'])) {
              <div class="invalid-feedback d-block">
                @if (formValues['confirmPassword'].errors?.['required']) {
                <span>{{ 'auth.confirmPasswordRequired' | transloco }}</span>
                }
                @if (resetPasswordForm.errors?.['passwordMismatch']) {
                <span>{{ 'auth.passwordMismatch' | transloco }}</span>
                }
              </div>
              }
            </div>

            <!-- Botones -->
            <div class="mb-3 text-center d-grid gap-2">
              <button class="btn btn-primary" type="submit" [disabled]="loading">
                @if (loading) {
                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                {{ 'auth.resettingPassword' | transloco }}
                } @else {
                <i class="mdi mdi-lock-reset me-1"></i>
                {{ 'auth.resetPassword' | transloco }}
                }
              </button>
            </div>

            <div class="text-center">
              <p class="text-muted">
                <small>
                  <i class="mdi mdi-shield-check-outline me-1"></i>
                  {{ 'auth.passwordSecurityNote' | transloco }}
                </small>
              </p>
            </div>
            }
          </form>
          }
        </div>
        <!-- end card-body -->
      </div>
      <!-- end card -->

      <div class="row mt-3">
        <div class="col-12 text-center">
          <p class="text-white-50">
            {{ 'auth.backToLoginText' | transloco }} <a [routerLink]="['/auth/login']" class="text-white ms-1"><b>{{
                'auth.backToLoginLink' | transloco }}</b></a>
          </p>
        </div>
        <!-- end col -->
      </div>
      <!-- end row -->
    </div>
    <!-- end col -->
  </div>
  <!-- end row -->
</app-default-layout>